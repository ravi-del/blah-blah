# Waybill as a service

This service generates and manages the waybills for Delhivery clients.

## Tools & Libraries
The Waybill service is comprised of following tools and libraries: <br/>
JAVA   : Programming language<br/>
Vert.x : Web application framework<br/>
Maven  : Build tool <br/>
Github : Git repository hosted server<br/>

## Catalogue

### Maven Projects
#### 1. `SfMain` 
* This project contains the code for all APIs of Waybill Service.
* StartVerticle.java is where the execution starts. This will deploy three Vertx verticles namely `HttpVerticle`,`LotWaybillVerticle`,`HttpClientVerticle`.
 * `HttpVerticle` - Reads the configuration file and starts HTTP server on a port.
 * `LotWaybillVerticle` - Registers the request handlers to the corresponding classes.
 * `HttpClientVerticle` - This is where waybill service can request external APIs and use the response.
* `HttpVerticle` also registers the classes which handle request of a particular url, these classes will sends the request to classes registered in `LotWaybillVerticle`.
* The `conf/` directory contains the configuration pertaining to the environments like _development_, _Quality Assurance_, _production_ which can be selected while execution.
* `Startup.sh` contains the execution script.

#### 2. `lambdas`
* This project creates waybills for lots whose size is greater than 25. The first 25 waybills are created in `SfMain` and the later are created in `lambdas`.
* The _Current Status_ of a Lot created with size greater than 25 will be updated from _PENDING_ to _READY_ after all the waybills of that Lot are created in AWS lambda.
* The Fat JAR of this project is deployed on AWS lambda which will be trigerred whenever a Waybill Lot is created.

#### 3. `Util` 
* This project is used as library by `SfMain` and `lambdas` projects. The libraries in Fat JARs of `SfMain` and `lambdas` will contain this project as well.
* A brief contents of this project will include:
 * `HttpVerticle` which starts HTTP server.
 * Code for handling the response generated by APIs.
 * Algorithms for waybill generation.

- - - -

### Database Tables
 Amazon DynamoDB is used to store these tables.
#### 1. Lots Table (_waybill.lot_)
This table contains the meta information about a lot.
#### 2. Prefix Table (_waybill.prefix_)
#### 3. Client Sequence Table (_waybill.clientSequence_)
#### 4. Waybills Table (_waybill.waybills_)

#### NOTE:
Seperate tables are created for each of the environments namely 
* Development environment
* Testing environment
* Production environment 

The naming of DynamoDB tables for each of these environments will have the following suffixes to the table names mentioned above:
* No suffix is used for development environment .
* __-QA__ is used for testing environment.
* __-prod__ is used for production environment.

- - - -

### APIs
All api validate the input as a first step and then proceed further
#### 1. Create Lot 
This API Creates Waybill Lots.
The API does the following steps:
* It gets Client Information and validates it.
* Then it checks in guava cache if the prefix belongs to the same client. If yes, it will proceed to the next step else, it reserves the prefix in the __Prefix Table__ for that specific client and updates it in the guava cache.
* It gets the starting sequence for generating waybills from __Client Sequence Table__.
* If the lot size is greater than 25, only the first 25 lots are created with the lot status as "_PENDING_" and the later are created by `lambdas` project in AWS lambda which will be triggered after adding the lot information in __Lots Table__.
* After the creation of later sequence waybills in AWS lambda the status of the lot will be updated to "_READY_".

#### 2. Lot by ID
This API gets the information of a Waybill Lot.

#### 3. Lots by Client

#### 4. Create Dynamic Waybill
#### 5. Consume Waybill
#### 6. UnConsume Waybill
#### 7. Waybill by ID
#### 8. Validate Waybill

## Execution
```bash
git clone https://ravi-del@bitbucket.org/DelhiveryTech/waybill_service.git
cd Util/utils
mvn clean install
cd ../../SfMain/
mvn clean package
chmod +x startup.sh
./startup.sh
```
