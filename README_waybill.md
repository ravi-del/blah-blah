# Waybill as a service

This service generates and manages the waybills for Delhivery clients.

## Tools & Libraries
The Waybill service is comprised of following tools : <br/>
JAVA   : Programming language<br/>
Vert.x : Web application framework<br/>
Maven  : Build tool <br/>
Github : Git repository hosted server<br/>

## Catalogue

### Maven Projects
#### 1. `SfMain` 
* This project contains the code for all APIs of Waybill Service.
* StartVerticle.java is where the execution starts. This will deploy three Vertx verticles namely `HttpVerticle`,`LotWaybillVerticle`,`HttpClientVerticle`.
 * `HttpVerticle` - Reads the configuration file and starts HTTP server on a port.
 * `LotWaybillVerticle` - Registers the request handlers to the corresponding classes.
 * `HttpClientVerticle` - This is where waybill service can request external APIs and use the response.
* `HttpVerticle` also registers the classes which handle request of a particular url, these classes will sends the request to classes registered in `LotWaybillVerticle`.
* The `conf/` directory contains the configuration pertaining to the environments like _development_, _Quality Assurance_, _production_ which can be selected while execution.
* `Startup.sh` contains the execution script.

#### 2. `lambdas`
* This project creates waybills for lots whose size is greater than 25. The first 25 waybills are created in `SfMain` and the later are created in `lambdas`.
* The _Current Status_ of a Lot created with size greater than 25 will be updated from _PENDING_ to _READY_ after all the waybills of that Lot are created in AWS lambda.
* The Fat JAR of this project is deployed on AWS lambda which will be trigerred whenever a Waybill Lot is created.

#### 3. `Util` 
* This project is used as library by `SfMain` and `lambdas` projects. The libraries in Fat JARs of `SfMain` and `lambdas` will contain this project as well.
* A brief contents of this project will include:
 * `HttpVerticle` which starts HTTP server.
 * Code for handling the response generated by APIs.
 * Algorithms for waybill generation.

- - - -

### Database Tables
 Amazon DynamoDB is used to store these tables.
#### 1. Lots Table (_waybill.lot_)
This table contains the meta information about a lot.
#### 2. Prefix Table (_waybill.prefix_)
This table contains the prefix information of a particular client.
#### 3. Client Sequence Table (_waybill.clientSequence_)
This table contains the last sequence used to generate the latest waybill of a particular client.
#### 4. Waybills Table (_waybill.waybills_)
This table contains the meta information about a waybill.

#### NOTE:
Seperate tables are created for each of the environments namely 
* Development environment
* Testing environment
* Production environment 

The naming of DynamoDB tables for each of these environments will have the following suffixes to the table names mentioned above:
* No suffix is used for development environment .
 eg: _waybill.lot_
* __-QA__ is used for testing environment.
 eg: _waybill.lot-QA_
* __-prod__ is used for production environment.
 eg: _waybill.lot-prod_

- - - -

### APIs
All APIs validate the request as a first step and then proceed further.
#### 1. Create Lot 
This API Creates Waybill Lots.</br>
The API does the following steps:
* It gets Client Information and validates it.
* Then it checks in guava cache if the prefix belongs to the same client. If yes, it will proceed to the next step else, it reserves the prefix in the __Prefix Table__ for that specific client and updates it in the guava cache.
* It gets and updates the starting sequence for generating waybills from __Client Sequence Table__.
* It then gets the algorithm of client for waybill generation from guava cache. If not present it fetches it from __Client Sequence Table__ and updates it in the guava cache.
* If the lot size is greater than 25, only the first 25 lots are created and populated in __Waybills Table__ and then the Lot information is added in __Lots Table__ with lot status as _"PENDING"_.
* The later are created by `lambdas` project in AWS lambda which will be triggered after adding the lot information in __Lots Table__ and after the creation of later sequence waybills the status of the lot will be updated to _"READY"_.

#### 2. Lot by ID
This API gets all the available waybills of a Waybill Lot.</br>
The API fetches all the available waybills of the Lot from __Waybills Table__ using the Table index created around lot IDs and then sends these waybills in the response.

#### 3. Lots by Client
This API gets meta information about all the lots of a particluar client.</br>
The API gets all Lots of a particular client from __Lots Table__ using Table index created around Client IDs and sends these in the response.

#### 4. Create Dynamic Waybill
This API dynamically creates one waybill for a client.</br>
The API does the following steps:
* It checks in guava cache if the prefix belongs to the same client. If yes, it will proceed to the next step else, it reserves the prefix in the __Prefix Table__ for that specific client and updates it in the guava cache.
* It gets and updates the starting sequence for generating waybills from __Client Sequence Table__.
* It then gets the algorithm of client for waybill generation from guava cache. If not present it fetches algorithm from __Client Sequence Table__ and updates it in the guava cache. If not present in __Client Sequence Table__ the algorithm is chosen as _"DEFAULT"_.
* The algorithm is then used to create the waybill number.

#### 5. Consume Waybill
This API consumes a waybill.</br>
The API does the following steps:
* Consumes the waybill by updating the availability status of the waybill in __Waybills Table__ from True to False.
* It then updates the number of available waybills of the Lot to which this waybill belongs in __Lots Table__.

#### 6. UnConsume Waybill
This API unconsumes a waybill.</br>
The API does the following steps:
* Consumes the waybill by updating the availability status of the waybill in __Waybills Table__ from False to True.
* It then updates the number of available waybills of the Lot to which this waybill belongs in __Lots Table__.

#### 7. Waybill by ID
This API gets the meta information about a waybill.</br>
The API gets the information of the waybill from __Waybills Table__ and sends the required information in the response.

#### 8. Validate Waybill
This API validates a waybill.</br>
The API does the following steps:
* It gets the algorithm of client for waybill generation from guava cache. If not present it fetches algorithm from __Client Sequence Table__ and updates it in the guava cache. If not present in __Client Sequence Table__ the algorithm is chosen as _"DEFAULT"_.
* It then validates the waybill by checking if the waybill fits the algorithm.

## Execution
1. Clone the git hub repository to local.</br>
`git clone https://ravi-del@bitbucket.org/DelhiveryTech/waybill_service.git`

2. Build the `lambdas` project to make a library of it in maven repository
```bash
cd Util/utils
mvn clean install
```

3. Create a Fat JAR of SfMain and execute it using the shell script
```
cd ../../SfMain/
mvn clean package
chmod +x startup.sh
./startup.sh
```
### `Startup.sh`
The execution environment can be changed by specifying the path of corresponding environment's configuration file after `-conf` in `Startup.sh` file.
